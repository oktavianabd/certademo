---
version: 1.0
name: disk_full
description: handle when host out of disk space

input:
  - hostip
vars:
  - bigfile: null

tasks:
  checkdisk:
    action: core.remote_sudo
    input:
      cmd: "ls -lh /var/log/big*.log"
      hosts: <% ctx().hostip %>
    next:
      - when: <% succeeded %>
        do: notify
        publish:
          - bigfile: <% result().hostip.stdout %>

  notify:
    action: chatops.post_message
    input:
      channel: stackstorm-demo
      message: |
        Summary: Disk on <% ctx().hostip %> is out of disk space
        We found big log file <% ctx().bigfile %>, do you want to remove it?
# output:
#   - stdout: <% ctx(stdout) %> 
  #   next:
  #     - when: <% succeeded %>
  #       do: get_approval
        
  # get_approval:
  #   action: core.ask
  #   input:
  #     schema:
  #       type: object
  #       properties:
  #         approved:
  #           type: boolean
  #           description: We found big log file, do you want to remove it?
  #           required: True
  #   next:
  #     - when: <% succeeded %>
  #       do: remove_logs

  # notify:
  #   action: chatops.post_message
  #   input:
  #     channel: stackstorm-demo
  #     message: |
  #       Summary: Disk on <% ctx().hostip %> is out of disk space
  #       Will try to remove files big*.log on /var/log/
  #   next:
  #     - when: <% succeeded %>
  #       do: remove_logs
  
  # remove_logs:
  #   action: linux.rm
  #   input:
  #     hosts: <% ctx().hostip %>
  #     target: /var/log/big*.log
  #     sudo: true
  #   next:
  #     - when: <% failed() %>
  #       do: failure
  #       # publish:
  #       #   - stdout: <% result().stdout %>
  #     - when: <% succeeded() %>
  #       do: success
  #       # publish:
  #       #   - stdout: <% result().stdout %>

  # failure:
  #   action: chatops.post_message
  #   input:
  #     channel: stackstorm-demo
  #     message: |
  #       Summary: Remove logs failed

  # success:
  #   action: chatops.post_message
  #   input:
  #     channel: stackstorm-demo
  #     message: |
  #       Summary: Remove logs successful  
      