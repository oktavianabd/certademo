---
version: 1.0
name: disk_full
description: handle when host out of disk space

input:
  - hostip


tasks:
  checkdisk:
    action: core.remote_sudo
    input:
      cmd: "ls -lh /var/log/big*.log"
      hosts: <% ctx().hostip %>
    next:
      - when: <% succeeded %>
        do: notify
        publish:
          - stdout: <% result().get(ctx().hostip).stdout %>
          - this_task_no_arg: '{{ task().task_id }}'
          - this_task_by_name: '{{ task("task1").task_id }}'
          # - task_ex_id: <% task().task_execution_id %>
          # - wf_ex_id: <% task().workflow_execution_id %>
          # - task_name: <% task().task_name %>
          # - task_id: <% task("checkdisk").result %>
  notify:
    action: chatops.post_message
    input:
      channel: stackstorm-demo
      message: |
        Summary: Disk on <% ctx().hostip %> is out of disk space
        We found big log files as below:
        <% ctx().stdout %>
        {{ ctx("this_task_no_arg") }}
        {{ ctx("this_task_by_name") }}
output:
  - stdout: <% ctx(stdout) %>
  - this_task_no_arg: '{{ ctx("this_task_no_arg") }}'
  - this_task_by_name: '{{ ctx("this_task_by_name") }}'

  # - task_ex_id: <% ctx(task_ex_id) %>
  # - wf_ex_id: <% ctx(wf_ex_id) %>
  # - task_name: <% ctx(task_name) %>
  # - task_id: <% ctx(task_id) %>

#        <% ctx().task_ex_id %>
#        <% ctx().wf_ex_id %>
#        <% ctx().task_name %>
        # <% ctx().task_id %>


  #   next:
  #     - when: <% succeeded %>
  #       do: get_approval 

  # get_approval:
  #   action: core.ask
  #   input:
  #     schema:
  #       type: object
  #       properties:
  #         approved:
  #           type: boolean
  #           description: Do you want to continue to remove the log files?
  #           required: True
  #   next:
  #     - when: <% succeeded %>
  #       do: remove_logs

  # remove_logs:
  #   action: linux.rm
  #   input:
  #     hosts: <% ctx().hostip %>
  #     target: /var/log/big*.log
  #     sudo: true
  #   next:
  #     - when: <% failed() %>
  #       do: failure
  #       # publish:
  #       #   - stdout: <% result().stdout %>
  #     - when: <% succeeded() %>
  #       do: success
  #       # publish:
  #       #   - stdout: <% result().stdout %>

  # failure:
  #   action: chatops.post_message
  #   input:
  #     channel: stackstorm-demo
  #     message: |
  #       Summary: Remove logs failed

  # success:
  #   action: chatops.post_message
  #   input:
  #     channel: stackstorm-demo
  #     message: |
  #       Summary: Remove logs successful