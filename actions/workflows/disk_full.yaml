---
version: 1.0
name: disk_full
description: handle when host out of disk space

input:
  - hostip

output:
  - stdout: <% ctx(stdout) %>

tasks:
  checkdisk:
    action: core.remote_sudo
    input:
      cmd: "ls -lh /var/log/big*.log"
      hosts: <% ctx().hostip %>
    next:
      - when: <% succeeded %>
        do: notify
        publish:
          - stdout: <% result().get(ctx().hostip).stdout %>
  notify:
    action: chatops.post_message
    input:
      channel: stackstorm-demo
      message: |
        Alert: Disk on <% ctx().hostip %> is out of disk space
        List of log files, do you want to remove it?
        <% ctx().stdout %>
    next:
      - when: <% succeeded %>
        do: get_approval 

  get_approval:
    action: core.ask
    input:
      schema:
        type: object
        properties:
          approved:
            type: boolean
            description: Do you want to continue to remove the log files?
            required: True
    next:
      - when: <% succeeded and task(get_approval).result.response.approved = true %>
        do: remove_logs
      - when: <% succeeded and task(get_approval).result.response.approved = false %>
        do: stop
  
  stop:
    action: chatops.post_message channel="stackstorm-demo" message="Un-approved, Automation stopped."

  remove_logs:
    action: linux.rm
    input:
      hosts: <% ctx().hostip %>
      target: /var/log/big*.log
      sudo: true
    next:
      - when: <% failed() %>
        do: failure
        publish:
          - rm_failed: <% result().get(ctx().hostip).stderr %>
      - when: <% succeeded() %>
        do: success
        publish:
          - rm_success: <% result().get(ctx().hostip).stdout %>

  failure:
    action: chatops.post_message
    input:
      channel: stackstorm-demo
      message: |
        Result: Remove logs failed
        <% ctx().rm_failed %>
  success:
    action: chatops.post_message
    input:
      channel: stackstorm-demo
      message: |
        Result: Remove logs successful
        <% ctx().rm_success %>