version: 1.0
name: "newticket_jirav2"
description: "handle new ticket from jira v2"

input:
  - issue_key
  - summary
  - description

tasks:
  notify:
    action: chatops.post_message
    input:
      channel: stackstorm-demo
      message: |
        There is new ticket from jira
        Ticket key: <% ctx().issue_key %>
        Summary: <% ctx().summary %>
        Ticket description: <% ctx().description %>
    next:
      - when: <% succeeded %>
        do: 
         - usercreate
         - postjiracomment
  usercreate:
    action: core.remote_sudo
    input:
      cmd: useradd bryan && echo "bryan:p@ssword" | chpasswd
      hostname: 10.63.20.2
  postjiracomment:
    action: comment_issue
    input:
      comment_text: New username bryan has been created, default password is p@ssword, please change the default password immediately.
      issue_key: <% ctx().issue_key %>